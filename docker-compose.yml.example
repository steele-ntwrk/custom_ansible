# docker-compose.yml
version: "3.9"

services:
  ansible:
    # Use either build: or image:. If you built locally, keep both.
    build:
      context: .
      dockerfile: Dockerfile
    image: custom_ansible_netbox:latest
    container_name: netbox-ansible
    stdin_open: true
    tty: true
    env_file:
      - ./ansible.env
    environment:
      TZ: Australia/Sydney
      # NetBox creds pulled from .env (recommended)
      # Only needed if you chose Option A (system-site installs)
      PIP_BREAK_SYSTEM_PACKAGES: "1"
      # Optional: widen Ansible paths for roles/collections under /work
      ANSIBLE_COLLECTIONS_PATHS: "/etc/ansible/collections:/usr/share/ansible/collections:/work/collections"
      ANSIBLE_ROLES_PATH: "/etc/ansible/roles:/usr/share/ansible/roles:/work/roles"
    volumes:
      # Workspace on host (edit here)
      - ./work:/work
      # Optional: cache/facts persist between runs
      - ./ansible_cache:/var/cache/ansible
      # Optional: bind your SSH keys/known_hosts (read-only)
      - ./ssh:/root/.ssh:ro
    networks:
      LabDocker:
        ipv4_address: IP

    working_dir: /work
    # Keep the container alive for interactive use
    command: [ "bash" ]
    healthcheck:
      test: ["CMD-SHELL", "ansible --version >/dev/null 2>&1"]
      interval: 30s
      timeout: 5s
      retries: 3
    restart: "no"


networks:
  LabDocker:
    external: true
